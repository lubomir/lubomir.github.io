<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.css">
    <link rel="alternate" type="application/rss+xml" href="../en/posts.atom">
    <link rel="icon" type="image/vnd.microsoft.icon" href="../favicon.ico">
    <title>Clickable Pungi logs</title>
  </head>

  <body id="top">

    <div class="container">
      <h1>Clickable Pungi logs</h1>

<div class="row metainfo">
    <div class="col-md-4">
        <a href="../">back to main page</a>
    </div>
    <div class="col-md-4">
        <strong>September 25, 2016</strong>
    </div>

    <div class="col-md-4">
        <span>Tagged as: <a href="../en/tags/fedora.html">Fedora</a>, <a href="../en/tags/pungi.html">Pungi</a>, <a href="../en/tags/java-script.html">Java Script</a>, <a href="../en/tags/logs.html">logs</a>.</span>
    </div>
</div>

<div class="post">
    <article>
        <p>When debugging problems with composes, the logs left behind by all stages of the compose run are tremendously helpful. However, they are rather difficult to read due to the sheer volume. Being exposed to them quite intensively for close to a year helps, but it still is a nasty chore.</p>
<p>The most accessible way to look at the logs is via a web browser on <a href="https://kojipkgs.fedoraproject.org/compose/rawhide/">kojipkgs</a>. It's just <em>httpd</em> displaying the raw log files on the disk.</p>
<p>It took me too long to figure out this could be made much more pleasant that copy-pasting stuff from the wall of text.</p>
<p>How about a user script that would run in <a href="http://www.greasespot.net/">Greasemonkey</a> and allow clicking through to different log files or even Koji tasks?</p>
<figure>
<img src="../images/kojipkgs-screenshot.png" alt="Is this not better?" /><figcaption>Is this not better?</figcaption>
</figure>
<p>Turns out it's not that difficult.</p>
<p>Did you know that when Firefox displays a <code>text/plain</code> file, it internally creates an HTML document with all the content in one <code>&lt;pre&gt;</code> tag.</p>
<p>The whole script essentially just runs a search and replace operation on the whole page. We can have a bunch of functions that take the whole content as text and return it slightly modified.</p>
<p>First step will make URLs clickable.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">link_urls</span>(str) <span class="op">{</span>
  <span class="kw">let</span> pat <span class="op">=</span> <span class="ss">/https</span><span class="sc">?</span><span class="ss">:</span><span class="sc">\/\/(</span><span class="ss">www</span><span class="sc">\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&amp;//=]*)</span><span class="ss">/g</span><span class="op">;</span>
  <span class="cf">return</span> <span class="va">str</span>.<span class="at">replace</span>(pat<span class="op">,</span> <span class="st">'&lt;a href=&quot;$&amp;&quot;&gt;$&amp;&lt;/a&gt;'</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>I didn't write the crazy regular expression myself. I got from <a href="http://stackoverflow.com/a/3809435/1576064">Stack Overflow</a>.</p>
<p>Next step can make paths to other files in the same compose clickable.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">link_local_files</span>(url<span class="op">,</span> pathname<span class="op">,</span> mount<span class="op">,</span> str) <span class="op">{</span>
  <span class="kw">let</span> pat <span class="op">=</span> <span class="kw">new</span> <span class="at">RegExp</span>(mount <span class="op">+</span> pathname <span class="op">+</span> <span class="st">'(/[^ ,&quot;</span><span class="sc">\n</span><span class="st">]+)'</span><span class="op">,</span> <span class="st">'g'</span>)<span class="op">;</span>
  <span class="cf">return</span> <span class="va">str</span>.<span class="at">replace</span>(pat<span class="op">,</span> <span class="kw">function</span> (path<span class="op">,</span> file) <span class="op">{</span>
    <span class="cf">return</span> <span class="st">'&lt;a href=&quot;'</span> <span class="op">+</span> url <span class="op">+</span> file <span class="op">+</span> <span class="st">'&quot;&gt;'</span> <span class="op">+</span> path <span class="op">+</span> <span class="st">'&lt;/a&gt;'</span><span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>The last thing left is not particularly general: linking Koji tasks identifiers.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">link_tasks</span>(taskinfo<span class="op">,</span> str) <span class="op">{</span>
  <span class="cf">return</span> <span class="va">str</span>.<span class="at">replace</span>(<span class="st">'\d{8,}/m'</span><span class="op">,</span> <span class="st">'&lt;a href=&quot;'</span> <span class="op">+</span> taskinfo <span class="op">+</span> <span class="st">'$&amp;&quot;&gt;$&amp;&lt;/a&gt;'</span>)
            .<span class="at">replace</span>(<span class="ss">/</span><span class="sc">(</span><span class="ss">Runroot task failed</span><span class="sc">|</span><span class="ss">'task_id'</span><span class="sc">)</span><span class="ss">: </span><span class="sc">(\d{8,})</span><span class="ss">/g</span><span class="op">,</span>
                     <span class="st">'$1: &lt;a href=&quot;'</span> <span class="op">+</span> taskinfo <span class="op">+</span> <span class="st">'$2&quot;&gt;$2&lt;/a&gt;'</span>)<span class="op">;</span>
  <span class="op">}</span>
}</code></pre></div>
<p>Tying all these steps together and passing in the extra arguments is rather trivial but not very generic.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">window</span>.<span class="at">onload</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
  <span class="kw">let</span> origin <span class="op">=</span> <span class="va">window</span>.<span class="va">location</span>.<span class="at">origin</span><span class="op">;</span>
  <span class="kw">let</span> pathname <span class="op">=</span> <span class="va">window</span>.<span class="va">location</span>.<span class="va">pathname</span>.<span class="at">split</span>(<span class="st">'/'</span><span class="op">,</span> <span class="dv">4</span>).<span class="at">join</span>(<span class="st">'/'</span>)<span class="op">;</span>
  <span class="kw">let</span> url <span class="op">=</span> origin <span class="op">+</span> pathname<span class="op">;</span>
  <span class="kw">let</span> taskinfo <span class="op">=</span> <span class="st">'https://koji.fedoraproject.org/koji/taskinfo?taskID='</span><span class="op">;</span>
  <span class="kw">let</span> mount <span class="op">=</span> <span class="st">'/mnt/koji'</span><span class="op">;</span>

  <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementsByTagName</span>(<span class="st">'pre'</span>)[<span class="dv">0</span>]<span class="op">;</span>
  <span class="kw">var</span> text <span class="op">=</span> <span class="va">content</span>.<span class="at">innerHTML</span><span class="op">;</span>
  <span class="va">content</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="at">link_local_files</span>(
    url<span class="op">,</span> pathname<span class="op">,</span> mount<span class="op">,</span>
    <span class="at">link_tasks</span>(taskinfo<span class="op">,</span> <span class="at">link_urls</span>(text))
  )<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>If you find this useful, feel free to grab <a href="../data/clickable-kojipkgs.user.js">the whole script with a header</a>.</p>
    </article>

    <h2 class="comments-header">Comments</h2>

    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "https://lubomir.github.io//en/2016-09-25-clickable-pungi-logs.html";
            this.page.identifier = "/en/2016-09-25-clickable-pungi-logs.html";
        };
        (function() {
            var d = document, s = d.createElement('script');
            s.src = '//indexoflsedlar.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div><!-- .container -->

    <footer class="container">
        <ul class="nav nav-pills">
          <li><a href="../">Home</a></li>
          <li><a href="#top">Back to top</a></li>
          <li><a href="mailto:lubomir.sedlar@gmail.com">Contact me</a></li>
          <li class="last"><a href="../cookies.html">Cookies</a></li>
          <li class="license"><a href="http://creativecommons.org/licenses/by/4.0/">
            <img src="../images/cc-by.png" alt="CC-BY" title="Licensed under Creative Commons Attribution"></a>
          </li>
        </ul>
    </footer><!-- .container -->

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40665960-1']);
        _gaq.push(['_trackPageview']);
        (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        window.cookieconsent_options = {"message":"This website uses some cookies.","dismiss":"Got it!","learnMore":"More info","link":"/cookies.html","theme":"dark-floating"};
     </script>
     <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
  </body>
</html>
