<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.css">
    <link rel="alternate" type="application/rss+xml" href="../en/posts.atom">
    <link rel="icon" type="image/vnd.microsoft.icon" href="../favicon.ico">
    <title>Poor Man's CI</title>
  </head>

  <body id="top">

    <div class="container">
      <h1>Poor Man's CI</h1>

<div class="row metainfo">
    <div class="col-md-4">
        <a href="../">back to main page</a>
    </div>
    <div class="col-md-4">
        <strong>March 8, 2016</strong>
    </div>

    <div class="col-md-4">
        <span>Tagged as: <a href="../en/tags/fedora.html">Fedora</a>, <a href="../en/tags/pagure.html">Pagure</a>, <a href="../en/tags/fedmsg.html">Fedmsg</a>, <a href="../en/tags/jenkins.html">Jenkins</a>, <a href="../en/tags/ci.html">CI</a>, <a href="../en/tags/testing.html">testing</a>.</span>
    </div>
</div>

<div class="post">
    <article>
        <p>I have been using <a href="https://pagure.io/">Pagure</a> quite intensively recently and the one thing I miss the most compared to GitHub is some sort of continuous integration. I just want to see the green check appear on my pull requests.</p>
<p>There is a not-very-advertised <a href="https://fedoraproject.org/wiki/Jenkins@infra">Jenkins server</a> used for Fedora Infrastructure. The project I'm working on primarily, <a href="https://pagure.io/pungi">Pungi</a>, has a couple unit tests that are run there after every push to <code>master</code> or some other long-lived branch.</p>
<p>This is a nice start, but leads to problems when new contributors submit their pull requests. Unless someone runs the tests manually, we won't know if they break.</p>
<p>As it turns out, it is quite possible to roll your own service to integrate the two.</p>
<h2 id="apply-mutagen-to-jenkins">Apply mutagen to Jenkins</h2>
<p>Step one on my journey to having CI was to customize the Jenkins job definition to be able to merge pull requests from any repository.</p>
<p>To be able to do so, I added two parameters. One is for the URL to the remote repository, the other for the branch.</p>
<figure>
<img src="../images/poormanci/parameters.png" alt="Jenkins Parameters" /><figcaption>Jenkins Parameters</figcaption>
</figure>
<p>These parameters are available as environment variables in the script that runs the tests. This snippet will add the repo with changes to be tested as a remote and merge the proposed branch on top of master.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">if [</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="ot">$REPO</span><span class="st">&quot;</span> <span class="ot">-a</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="ot">$BRANCH</span><span class="st">&quot;</span><span class="kw"> ]</span>; <span class="kw">then</span>
    <span class="kw">git</span> remote rm proposed <span class="kw">||</span> <span class="kw">true</span>
    <span class="kw">git</span> remote add proposed <span class="st">&quot;</span><span class="ot">$REPO</span><span class="st">&quot;</span>
    <span class="kw">git</span> fetch proposed
    <span class="kw">git</span> checkout origin/master
    <span class="kw">git</span> merge --no-ff <span class="st">&quot;proposed/</span><span class="ot">$BRANCH</span><span class="st">&quot;</span> -m <span class="st">&quot;Merge PR&quot;</span>
<span class="kw">fi</span></code></pre></div>
<p>Last part of the Jenkins change is allowing remotely triggered builds. To do this, it is necessary to set up an authentication token. Triggering a build is then a simple HTTP <code>POST</code> request with a <code>?cause=203&amp;REPO=https://example.com/repo.git&amp;BRANCH=merge-this-plz&amp;token=BEEFCAFE</code>.</p>
<p>The <code>cause</code> part is used to keep track of the pull request in question. It will come in handy later.</p>
<p>Since we need to get information about the builds in some way, it is necessary to enable sending messages to Fedmsg as a post-build action.</p>
<h2 id="supercharge-pagure-configuration">Supercharge Pagure configuration</h2>
<p>The configuration on Pagure side is not that complicated. All that needs to be done is enable Fedmsg integration and set up an API key. This key needs to be able to post comments to pull requests.</p>
<h2 id="one-integration-point-to-bind-them-all">One integration point to bind them all</h2>
<p>The last part is to run a service that will listen to the messaging bus and trigger actions as needed. When it hears about new or changed pull request, it should trigger a build in Jenkins. When a build finishes (and is actually a build that verified a pull request), a comment with details should be posted to proper place.</p>
<p>I put the code to do exactly this into a <a href="https://pagure.io/poor-man-ci">poor-man-ci</a> repo on Pagure.</p>
<p>I have deployed this thing on my VPS and so far it seems to be working quite well. Open infrastructure for the win!</p>
<h2 id="implementation-details">Implementation details</h2>
<p>The service is based on the <a href="https://github.com/fedora-infra/pdc-updater">pdc-updater</a> model. There is a consumer running as part of <code>fedmsg-hub</code>. It subscribes to three topics: one from Jenkins, one for new pull requests on Pagure and one for comments on existing pull requests.</p>
<p>As far as I could tell, Pagure does not send a separate message when pull request is updated or rebased. It does however add a comment with this information.</p>
<p>When a message from Pagure is received, the contents must be examined to determine if a build should be triggered. For new pull requests this is completely straightforward. For the update part we need to check if the last comment is one of the known strings and if the pull request is still open.</p>
<p>Messages from Jenkins are a lot simpler. In fact they don't contain pretty much anything but the build number. This is where <a href="http://python-jenkins.readthedocs.org/en/latest/">python-jenkins</a> comes into play. It is a library on top of Jenkins API which makes it relatively easy to get more details about the build. The only part I was interested in was the result (this is actually in the message directly) and the note with pull request number.</p>
<p>Finally the last part is to post a comment to Pagure. This is really trivial, just submit an HTTP <code>POST</code> request.</p>
<h2 id="deploying">Deploying</h2>
<p>Implementation wise, the hardest part for me was to package the whole service and get it running. During most of the development I was using the <code>fedmsg.tail_messages()</code> function, which was probably not meant for this use case.</p>
<p>Ultimately, I just ripped of existing projects, mostly <a href="https://github.com/fedora-infra/pdc-updater">pdc-updater</a> and <a href="https://github.com/fedora-infra/the-new-hotness">the-new-hotness</a>. That helped some, but there are still a couple open questions. For example, I have no idea why the packages do not depend on <code>fedmsg-hub</code> when they clearly need it to run.</p>
<p>My take away points for developing with Fedmsg are these:</p>
<p><strong>Point 1</strong>: Your <code>setup.py</code> must specify an entrypoint for <em>moksha</em>.</p>
<div class="sourceCode"><pre class="sourceCode ini"><code class="sourceCode ini"><span class="kw">[moksha.consumer]</span>
<span class="dt">integrator </span><span class="ot">=</span><span class="st"> poormanci.consumer:Integrator</span></code></pre></div>
<p>This will get installed together with egg-info and the hub will somehow pick it up. The name of the key is not important. The value should point to a Python module containing a subclass of the <code>FedmsgConsumer</code>.</p>
<p><strong>Point 2</strong>: The consumer class should have <code>topic</code> attribute listing all the topics you are interested in, a <code>config_key</code> attribute with the name of the configuration key that controls whether this consumer is enabled and finally a <code>consume</code> method that will be called with the message received.</p>
<p><strong>Point 3</strong>: The configuration file needs to live in <code>/etc/fedmsg.d</code>. Its name is not important. It must be a Python module that defines a single value <code>config</code> as a dict. It should contain at least the configuration code mentioned above to enable the consumer, but can have arbitrary other stuff. I put the API keys there, for example.</p>
<p><strong>Point 4</strong>: The actual packaging (as in how to install the software) is not really important as long as the module with the consumer can be imported and the egg-info directory gets install into Python site lib.</p>
<p><strong>Point 5</strong>: I had to restart the hub to have it pick up updates. This is as easy as <code>systemctl restart fedmsg-hub.service</code>.</p>
<p><strong>Point 6</strong>: I found it helpful to tail the hub logs to see what is happening – <code>journalctl -f -u fedmsg-hub.service</code>. This log also contains traceback when the consumer crashes.</p>
    </article>

    <h2 class="comments-header">Comments</h2>

    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = "https://lubomir.github.io//en/2016-03-08-poor-man-ci.html";
            this.page.identifier = "/en/2016-03-08-poor-man-ci.html";
        };
        (function() {
            var d = document, s = d.createElement('script');
            s.src = '//indexoflsedlar.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div><!-- .container -->

    <footer class="container">
        <ul class="nav nav-pills">
          <li><a href="../">Home</a></li>
          <li><a href="#top">Back to top</a></li>
          <li><a href="mailto:lubomir.sedlar@gmail.com">Contact me</a></li>
          <li class="last"><a href="../cookies.html">Cookies</a></li>
          <li class="license"><a href="http://creativecommons.org/licenses/by/4.0/">
            <img src="../images/cc-by.png" alt="CC-BY" title="Licensed under Creative Commons Attribution"></a>
          </li>
        </ul>
    </footer><!-- .container -->

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40665960-1']);
        _gaq.push(['_trackPageview']);
        (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        window.cookieconsent_options = {"message":"This website uses some cookies.","dismiss":"Got it!","learnMore":"More info","link":"/cookies.html","theme":"dark-floating"};
     </script>
     <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
  </body>
</html>
