<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>lsedlar – Posts tagged Django</title>
    <link href="https://lubomir.github.io/en/tags/django.atom" rel="self" />
    <link href="https://lubomir.github.io" />
    <id>https://lubomir.github.io/en/tags/django.atom</id>
    <author>
        <name>Lubomír Sedlář</name>
        <email>lubomir.sedlar@gmail.com</email>
    </author>
    <updated>2016-01-06T19:52:56Z</updated>
    <entry>
    <title>Exploring test case fixtures in Django</title>
    <link href="https://lubomir.github.io/en/2014-09-18-exploring-django-fixtures.html" />
    <id>https://lubomir.github.io/en/2014-09-18-exploring-django-fixtures.html</id>
    <published>2014-09-18T00:00:00Z</published>
    <updated>2016-01-06T19:52:56Z</updated>
    <summary type="html"><![CDATA[<p><a href="https://www.djangoproject.com/">Django</a> has a nice feature for exploring the environment in which the tests run via the <code>testserver</code> command. You can give it paths to fixture files used in the test case you want and go crazy.</p>
<p>However, this use case becomes really unpleasant once you need to load bigger number of fixtures. It would be much more user friendly if you could instead tell it what test case you want to explore and the script automatically inferred what fixtures to load.</p>
<p>The <code>--help</code> output is silent on this, so let's roll our own solution to this. The script will have two mandatory arguments: module containing the tests and the actual test case name.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">run-test-server.py</span> myapp.tests MyComplicatedTestCase</code></pre></div>
<p>The first idea how to proceed is to simply import the module and look at <code>fixtures</code> attribute of the test case. Sadly, it is not that easy. Importing the module fails with <code>ImproperlyConfiguredException</code> because simply importing a module would be too much to ask for without loading all the <a href="https://www.djangoproject.com/">Django</a> settings. This could be a whole other rant.</p>
<p>Since <code>__import__</code> is slightly more complicated that necessary, let's offload the actual importing to <code>importlib.import_module</code> which works exactly as expected. However, it is only available since Python 2.7.</p>
<p>Once the module is imported, all that needs to be done is to retrieve the test case, its fixtures and fire out the <code>testserver</code> command with appropriate arguments.</p>
<p>The whole script looks as follows. The only unexplained part is the modification of path. This needs to be done so that the script can be located anywhere and still manage to import modules from current directory.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co">#! /usr/bin/env python</span>

<span class="im">import</span> argparse
<span class="im">from</span> subprocess <span class="im">import</span> call
<span class="im">import</span> sys
<span class="im">import</span> importlib

<span class="im">from</span> django.conf <span class="im">import</span> settings


<span class="kw">def</span> get_fixtures(module, case):
    settings.configure()
    parts <span class="op">=</span> module.split(<span class="st">&#39;.&#39;</span>)

    app <span class="op">=</span> importlib.import_module(module)
    <span class="cf">return</span> <span class="bu">getattr</span>(app, case).fixtures


<span class="kw">def</span> main():
    parser <span class="op">=</span> argparse.ArgumentParser()
    parser.add_argument(<span class="st">&#39;MODULE&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)
    parser.add_argument(<span class="st">&#39;TEST_CASE&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>)

    args <span class="op">=</span> parser.parse_args()
    fixtures <span class="op">=</span> get_fixtures(args.MODULE, args.TEST_CASE)

    call([<span class="st">&quot;python&quot;</span>, <span class="st">&quot;manage.py&quot;</span>, <span class="st">&quot;testserver&quot;</span>] <span class="op">+</span> fixtures)


<span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:
    sys.path.append(<span class="st">&#39;.&#39;</span>)
    main()</code></pre></div>
<h2 id="further-improvements">Further improvements</h2>
<p>This script could obviously use a bit more polish:</p>
<ul>
<li>The help output could be more helpful.</li>
<li>If something breaks, the user is presented with a stack trace. Not nice.</li>
</ul>]]></summary>
</entry>

</feed>
